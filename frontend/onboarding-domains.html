<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Onboarding (2/3): Domains</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>.domain-card { cursor: pointer; border: 1px solid #dee2e6; } .domain-card.selected { border-color: #0d6efd; background-color: #e7f1ff; }</style>
</head>
<body class="bg-light">
    <div class="container">
        <div class="row justify-content-center" style="padding-top: 5vh;">
            <div class="col-md-8 col-lg-7">
                <div class="card shadow"><div class="card-body p-4 p-md-5">
                    <h2 class="card-title text-center mb-4">What's Your Field?</h2>
                    <div class="progress mb-4" style="height: 10px;"><div class="progress-bar" style="width: 66%;"></div></div>

                    <form id="domains-form">
                        <div class="mb-3">
                            <label for="branch-select" class="form-label">Select Your Engineering Branch*</label>
                            <select class="form-select" id="branch-select" required><option value="">-- Loading Branches --</option></select>
                        </div>
                        <div class="mb-4">
                            <label class="form-label">Select Your Domain(s) of Interest*</label>
                            <div id="domains-container" class="d-flex flex-wrap gap-2"><p class="text-muted">Please select a branch first.</p></div>
                        </div>
                        <div class="d-grid"><button type="submit" class="btn btn-primary btn-lg">Next: Select Your Skills</button></div>
                    </form>
                </div></div>
            </div>
        </div>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            const branchSelect = document.getElementById('branch-select');
            const domainsContainer = document.getElementById('domains-container');
            let skillsData = {};

            // 1. Fetch the data from the JSON file
            try {
                const response = await fetch('/skills-data.json');
                skillsData = await response.json();
            } catch (error) {
                console.error('Failed to load skills data:', error);
                domainsContainer.innerHTML = '<p class="text-danger">Could not load domains. Please refresh.</p>';
                return;
            }

            // 2. Populate the branch dropdown
            const btechBranches = skillsData.BTech;
            branchSelect.innerHTML = '<option value="">-- Select a Branch --</option>'; // Clear loading message
            for (const branchName in btechBranches) {
                const option = document.createElement('option');
                option.value = branchName;
                option.textContent = branchName;
                branchSelect.appendChild(option);
            }

            // 3. Listen for changes on the branch dropdown
            branchSelect.addEventListener('change', () => {
                const selectedBranch = branchSelect.value;
                domainsContainer.innerHTML = ''; // Clear previous domains
                if (!selectedBranch) {
                    domainsContainer.innerHTML = '<p class="text-muted">Please select a branch first.</p>';
                    return;
                }

                const domains = btechBranches[selectedBranch].domains;
                for (const domainName in domains) {
                    const card = document.createElement('div');
                    card.className = 'domain-card p-2 rounded';
                    card.textContent = domainName;
                    card.dataset.domainName = domainName; // Store name in data attribute
                    domainsContainer.appendChild(card);
                    
                    card.addEventListener('click', () => {
                        card.classList.toggle('selected');
                    });
                }
            });
            
            // 4. Handle the final form submission
            document.getElementById('domains-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const selectedBranch = branchSelect.value;
                const selectedDomainElements = domainsContainer.querySelectorAll('.selected');

                if (!selectedBranch || selectedDomainElements.length === 0) {
                    alert('Please select a branch and at least one domain.');
                    return;
                }
                
                const selectedDomains = Array.from(selectedDomainElements).map(el => el.dataset.domainName);

                const onboardingData = JSON.parse(localStorage.getItem('onboardingData')) || {};
                onboardingData.branch = selectedBranch;
                onboardingData.selectedDomains = selectedDomains;
                
                localStorage.setItem('onboardingData', JSON.stringify(onboardingData));
                window.location.href = '/onboarding-skills.html';
            });
        });
    </script>
</body>
</html>